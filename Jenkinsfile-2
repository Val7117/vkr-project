pipeline {
    agent any
    environment {
        GITHUB_TOKEN=credentials('my-github-token')
        COSIGN_PUBLIC_KEY=credentials('my-cosign-public-key')
    }
    parameters {
        string(name: 'GHCR_IMAGE_NAME', description: 'My GHCR image name')
    }
    stages {
         stage('Login to GitHub Container Registry') {
            steps {
                sh 'echo $GITHUB_TOKEN_PSW | docker login ghcr.io -u $GITHUB_TOKEN_USR --password-stdin'
            }
        }
        stage('Verify Docker image') {
            steps {
                sh "cosign verify --key ${COSIGN_PUBLIC_KEY} ${GHCR_IMAGE_NAME}"
            }
        }
        stage('SSH to private Docker registry and pulling image') {
            steps {
                script {
                    echo 'SSH to private docker repository'
                    def shellCmd = "docker pull ${GHCR_IMAGE_NAME}"
                    def instance = "root@164.92.201.106"

                    sshagent(['docker-registry-ssh']) {
                        sh "ssh -o StrictHostKeyChecking=no ${instance} ${shellCmd}"
                    }
                }
            }
        }
    }
}