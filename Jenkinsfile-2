pipeline {
    agent any
    environment {
        GITHUB_TOKEN=credentials('my-github-token')
        // IMAGE_NAME='val7117/vkr-project'
        IMAGE_VERSION='0.0.1'
        COSIGN_PUBLIC_KEY=credentials('my-cosign-public-key')
    }
    parameters {
        string(name: 'IMAGE_NAME', description: 'My image name')
        string(name: 'IMAGE_VERSION', description: 'My image version')
    }
    stages {
         stage('Login to GitHub Container Registry') {
            steps {
                sh 'echo $GITHUB_TOKEN_PSW | docker login ghcr.io -u $GITHUB_TOKEN_USR --password-stdin'
            }
        }
        stage('Verify Docker image') {
            steps {
                sh "cosign verify --key ${COSIGN_PUBLIC_KEY} ghcr.io/${params.IMAGE_NAME}:${params.IMAGE_VERSION}"
            }
        }
        stage('SSH to private Docker registry and pulling image') {
            steps {
                script {
                    echo 'SSH to private docker repository'
                    def shellCmd = "docker pull ghcr.io/$IMAGE_NAME:$IMAGE_VERSION"
                    def instance = "root@164.92.201.106"

                    sshagent(['docker-registry-ssh']) {
                        sh "ssh -o StrictHostKeyChecking=no ${instance} ${shellCmd}"
                    }
                }
            }
        }
    }
}